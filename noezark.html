<html>
<head>
	<style>
	</style>
</head>

<body>
	<div id="game">
		<canvas width="600" height="450" id="main" style="border:1px solid black"></canvas>
	</div>
	<script type="text/javascript" src="javascript/jquery-1.10.2.min.js"></script>
	<script type="text/javascript" src="javascript/jqueryhotkeys.js"></script>
	<script type="text/javascript" src="javascript/key_status.js"></script>
	<script type="text/javascript" src="level1.js"></script>
	<script type="text/javascript" src="level2.js"></script>	
	<script type="text/javascript">
	
	//Load Game Assets

	var collision_image = new Image();
	collision_image.src = "assets/Noezark_testscene_collision.png";
	
	var background_image = new Image();
	background_image.src = "assets/Noezark_testscene1.png";
	
	var lyda_image = new Image();
	lyda_image.src = "assets/lyda.png";
	
	var lyda_image_left = new Image();
	lyda_image_left.src = "assets/lyda-left.png";
	
	var bobcat_image = new Image();
	bobcat_image.src = "assets/bobcat_walk1_1.png";
	
	var background_mall_ground_image = new Image();
	background_mall_ground_image = "assets/background_mall_ground_Collison.png";

	var background_mall_ground_image = new Image();
	background_mall_ground_image.src = "assets/background_mall_ground_Collison.png";
	
	var background_mall_grass_image = new Image();
	background_mall_grass_image.src = "assets/background_mall_Grass.png";
	
	var background_mall_collison_image = new Image();
	background_mall_collison_image.src = "assets/background_mall_ground_Collison.png";
	
	var background_mall_platforms = new Image();
	background_mall_platforms.src = "assets/background_mall_platforms_collision.png";

	var foreground_grass_image = new Image();
	foreground_grass_image.src = "assets/foreground-grass.png";

	/* Set Canvas contexts */
				
	var canvas = document.getElementById("main")		
	var cxt = canvas.getContext("2d");

	var canvas_width = canvas.width;
    var canvas_height = canvas.height;
	

	
	//Figure out order of object declaration
	
	var location0 = {
		//Begin information specific to the location if any
		
		//End location specific information
		//Begin information needed for all locations
		//List all elements, will be drawn in sequence
		background: new Array(
			background_mall_grass_image,
			background_mall_ground_image, 
			background_mall_collison_image
		),
		foreground: new Array(),
		//Walls and platforms
		collision_map: new Array(
			{x:0, y:418, width:800, height:30},
			{x:64, y:257, width:192, height:10},
			{x:64, y:337, width:81, height:10},		
			{x:176, y:337, width:176, height:10}
		),
		//Enemies and locations
		enemies: new Array(
			{type: "Bobcat", x:95, y:310, width:26, height:41}, 
			{type: "Bobcat", x:90, y:305, width:26, height:41}
		),
		//Doors are entrance and exit points on map
		doors: new Array(
			{type:"normal", x:0, y:0, height:100, width:10, locked: true}, 
			{type:"normal", x:0, y:0, height:100, width:10, locked: true}
		),
		//Items
		item: new Array(
			{type:"Terrajump", x: 0, y:0}
		)
	}
	
	var location1 = {
		//Begin information specific to the location if any
		
		//End location specific information
		//Begin information needed for all locations
		//List all elements, will be drawn in sequence
		background: new Array(
			// background_mall_grass_image,
			background_mall_ground_image, 
			background_mall_collison_image
		),
		foreground: new Array(
			foreground_grass_image
		),
		//Walls and platforms
		collision_map: new Array(
			{x:0, y:418, width:800, height:30},
			{x:64, y:257, width:192, height:10},
			{x:64, y:337, width:81, height:10},		
			{x:176, y:337, width:176, height:10}
		),
		//Enemies and locations
		enemies: new Array(
			{type: "Bobcat", x:450, y:350}, 
			{type: "Bobcat", x:10, y:10}
		),
		//Doors are entrance and exit points on map
		doors: new Array(
			{type:"normal", x:0, y:0, height:100, width:10, locked: true}, 
			{type:"normal", x:0, y:0, height:100, width:10, locked: true}
		),
		//Items
		item: new Array(
			{type:"Terrajump", x: 0, y:0}
		)
	}
	
	//Main game data as well as viewport information, and general physics of the game
	//Maybe split this into separate objects
	var game_data = {
		current_time: new Date(),
		jump_max: 40,
		screen_left: 0,
		screen_top: 0,
		x_velocity: 0,
		y_velocity: 0,
		x_max: 5,
		y_max: 10,
		x_acceleration: 1,
		y_acceleration: 1.4,
		location: location0
	};
	
	
	//Loops through all background images and draws them one on top of each other
	function background_draw(location) {
		var background_array = location.background.length;
		for (var i = 0; i < background_array; i++ ) {
			cxt.drawImage(location.background[i], game_data.screen_left, game_data.screen_top);
		}
	}
	
	function foreground_draw(location) {
		var foreground_array = location.foreground.length;
		for (var i = 0; i < foreground_array; i++ ) {
			cxt.drawImage(location.foreground[i], game_data.screen_left, game_data.screen_top);
		}
	}
		
	//Returns the image data for the enemy type
	function enemy_image(type) {
		if (type == "Bobcat") {
			return bobcat_image;
		}
		else {
			console.log("No image for that enemy");
		}
	}
	
	//Loops through enemy array and draws all enemies
	//TODO add in functionality to change location of draw based on where the enemy should be
	function enemy_draw(location) {
		var enemies_array = location.enemies.length;
		for (var i = 0; i < enemies_array; i++ ) {
			cxt.drawImage(enemy_image(location.enemies[i].type), location.enemies[i].x, location.enemies[i].y);
		}
	}
	
	//Defines the collision_map, keeps it consistent to the map based on where the viewport is
	function collision_map_update(location) {
		var collision_map = location.collision_map.length;
		for (var i = 0; i < collision_map; i++ ) {
			location.collision_map[i].x = x + leftmost;
			location.collision_map[i].y = y + topmost;
		}
	}
	
	
	//Main character data and drawing
	//TODO move any character specific data from other objects into here
	//Add weapon data
	var lyda = {
		x: 100,
		y: 100,
		width: 38,
		height: 42,
		keyframe: 0,
		x_direction: "left",
		y_direction: "none",
		x_movement: "none",
		platform: false,	
		jump: 0,
		can_jump: false,
		draw: function() {
			if (this.x_direction == "right") {
				var crop_left = this.keyframe * this.width;
				cxt.drawImage(lyda_image, crop_left, 0, this.width, this.height, this.x, this.y, this.width, this.height);
			}
			else {
				var crop_left = this.keyframe * this.width;
				cxt.drawImage(lyda_image_left, crop_left, 0, this.width, this.height, this.x, this.y, this.width, this.height);
			}
		}
	}
	
	//TODO: rewrite for a check between any two objects in the game and return which side each object is being interacted with
	function collision_check(object1, object2) {

		var collided = {left:false, right:false, top:false, bottom:false};

	    if (object1.x > object2.x
			&& object1.x < object2.x + object2.width) 
			{
				collided.left = true;
			}
		if (object1.x + object1.width > object2.x
			&& object1.x + object1.width < object2.x + object2.width) 
			{
				collided.right = true;
			}
		if (object1.y > object2.y
			&& object1.y < object2.y + object2.height)
			{
				collided.top = true;
			}
		if (object1.y + object1.height > object2.y
			&& object1.y + object1.height < object2.y + object2.height)
			{
				collided.bottom = true;
			}
		if (collided.left && (collided.bottom || collided.top)) {console.log('left')}
		if (collided.right && (collided.bottom || collided.top)) {console.log('right')}
		if (collided.bottom && (collided.left || collided.right)) {console.log('bottom')}
		if (collided.top && (collided.left || collided.right)) {console.log('top')}						
	}
	
	//TODO make this a generic check to move any object in the correct direction
	//Takes objects' velocity to the game data velocity, current viewport, and pathfinding into consideration	
	function x_velocity_check(direction) {
		switch(lyda.x_movement) {
		case "left":
			if (game_data.x_velocity > 0) { game_data.x_velocity = 0};
			game_data.x_velocity <= (game_data.x_max * -1) ? game_data.x_velocity = game_data.x_velocity : game_data.x_velocity -= game_data.x_acceleration;
		break;
		case "right":
			if (game_data.x_velocity < 0) { game_data.x_velocity = 0};
			game_data.x_velocity == game_data.x_max ? game_data.x_velocity = game_data.x_velocity : game_data.x_velocity += game_data.x_acceleration;			
		break;
		
		case "none":
			game_data.x_velocity = 0;
		break;	
		}
	}
	
	//TODO make this a generic check to move any object in the correct direction
	//Takes objects' velocity to the game data velocity, current viewport, and pathfinding into consideration
	function y_velocity_check(direction) {
		switch(lyda.y_movement) {
		case "down":
			if (game_data.y_velocity <= 0) { game_data.y_velocity = 0.5};
			game_data.y_velocity >= game_data.y_max ? game_data.y_velocity = game_data.y_max : game_data.y_velocity = Math.ceil(game_data.y_velocity * game_data.y_acceleration);			
			console.log(game_data.y_velocity);
			console.log("down");			
		break;
		case "up":
			lyda.y -= 1;
			if (game_data.y_velocity >= 0) { game_data.y_velocity = -0.5};
			game_data.y_velocity >= (game_data.y_max * -1) ? game_data.y_velocity = (game_data.y_max * -1) : game_data.y_velocity = (Math.ceil(game_data.y_velocity * game_data.y_acceleration)) * -1;			
			console.log(game_data.y_velocity);
			console.log("up");
		break;
		}
	}

	//TODO Update should do a bunch of stuff based on key combinations, or lack thereof
	//Call functions to update object data, ie move objects, or destroy them
	//Additionally, check anything that should be checked each frame
	function update() {
		collision_check(location0.enemies[0], location0.enemies[1]);
		//Simple check to switch to a location and make sure everything is working
		if (keydown.b) {
			game_data.location = location1;
		}
		
		if (keydown.left) { location0.enemies[0].x -= 1}
		if (keydown.right) { location0.enemies[0].x += 1}		
		if (keydown.up) { location0.enemies[0].y -= 1}
		if (keydown.down) { location0.enemies[0].y += 1}		

		// check_solid_ground();
		// current_time = new Date();
		// 
		// if (keydown.left) {
		// 	//Point her in the right direction
		// 	lyda.x_direction = "left";		
		// 	//Set movement in right direction		
		// 	lyda.x_movement = "left";
		// 	//Continue velocity
		// 	x_velocity_check(lyda.x_movement);
		// 	//Advance animation frame
		// 	lyda.keyframe == 9 ? lyda.keyframe = 0 : lyda.keyframe += 1;
		// }
		// 
		// if (keydown.right) {
		// 	lyda.x_direction = "right";
		// 	lyda.x_movement = "right";
		// 	x_velocity_check(lyda.x_movement);
		// 	lyda.keyframe == 9 ? lyda.keyframe = 0 : lyda.keyframe += 1;
		// }
		// 
		// //Not moving left or right
		// if (!keydown.left && !keydown.right) {
		// 	lyda.x_movement = "none";
		// 	x_velocity_check(lyda.x_movement);
		// }
		// 
		// //TODO Aim gun in appropriate direction
		// if (keydown.down) {
		// 	lyda.y_direction = "down";
		// 	lyda.keyframe = 2;
		// }
		// if (keydown.up) {
		// 	lyda.y_direction = "up";
		// 	lyda.keyframe = 2;
		// }
		// 
		// //Jumping
		// if (keydown.b && lyda.jump <= game_data.jump_max && lyda.can_jump != false) {
		// 	lyda.y_movement = "up";
		// 	lyda.y_direction = "up";
		// 	lyda.keyframe = 2;			
		// 	y_velocity_check(lyda.y_movement);
		// 	lyda.jump += 5;
		// }
		// else if (keydown.b && lyda.jump >= game_data.jump_max) {
		// 	lyda.y_movement = "down";
		// 	lyda.y_direction = "down";			
		// 	lyda.keyframe = 2;			
		// 	y_velocity_check(lyda.y_movement);
		// }
		// else if (!keydown.b) {
		// 	lyda.can_jump = false;
		// 	lyda.jump < 0 ? lyda.jump = lyda.jump : lyda.jump -= 5;
		// 	game_data.y_velocity += 1;
		// }
		// 
		// //Handle platform logic for lyda
		// if (lyda.platform == false && lyda.jump == false) {
		// 	lyda.y_movement = "down";
		// 	y_velocity_check(lyda.y_movement);
		// }
		// else if (lyda.platform == "platform_top") {
		// 	lyda.can_jump = true;
		// 	lyda.jump = 0;
		// 	game_data.y_velocity = 0;
		// }
		// else if (lyda.platform == "platform_bottom") {
		// 	game_data.y_velocity = .0001;
		// }
		// 	
		// 
		// //Move level, lyda, or both
		// 
		// //Viewport at right edge of level
		// if (background.leftmost + canvas_width >= background.width && lyda.x_direction == "right") {
		// 	lyda.x < canvas.width - 50 ? lyda.x += game_data.x_velocity : lyda.x = lyda.x;
		// 	lyda.y += game_data.y_velocity;
		// }
		// //Viewport at left edge of level
		// else if (background.leftmost <= 1 && lyda.x_direction == "left") {
		// 	lyda.x > 1 ? lyda.x += game_data.x_velocity : lyda.x = lyda.x;
		// 	lyda.y += game_data.y_velocity;
		// }
		// //Viewport move left
		// else if (lyda.x < 250 && background.leftmost > 1 && lyda.x_direction == "left") {
		// 	background.leftmost += game_data.x_velocity;
		// 	lyda.y += game_data.y_velocity;			
		// 	
		// }
		// //Viewport move right
		// else if (lyda.x > 350 && background.leftmost + canvas_width < background.width && lyda.x_direction == "right") {
		// 	background.leftmost += game_data.x_velocity;
		// 	lyda.y += game_data.y_velocity;
		// }		
		// 
		// //Viewport doesn't move, lyda does
		// else {
		// 	lyda.x += game_data.x_velocity;
		// 	lyda.y += game_data.y_velocity;			
		// }
	}

//Set frame rate
	var fps = 30;

//Main drawing function calls itself, runs update, and draws everything it should
	function draw() {
		setTimeout(function() {
			requestAnimationFrame(draw);
			//Run update loop
			update();

			//Clear the canvas completely
			cxt.clearRect(0, 0, canvas.width, canvas.height);
			//Draw the current location with its data
			background_draw(game_data.location);
			//Draw the current location's enemy data
			enemy_draw(game_data.location);
			//Draw the current location's item data
			//Draw Lyda along with her stat
			
			//Draw foreground elements
			foreground_draw(game_data.location)
			//lyda.draw();

		}, 1000 / fps);
	}

	//Start it all off
		draw();
	</script>
</body>

</html>