<html>
<head>
	<style>
	body {
		background-color:gray;
	}
	#game {
		position: absolute;
		margin: auto;
		top: 0;
		right: 0;
		bottom: 0;
		left: 0;
		width:600px;
		height:450px;
		background-color:white;
	  }
	</style>
</head>

<body>
	<div id="game">
		<canvas width="600" height="450" id="main" style="border:1px solid black"></canvas>
	</div>
	<script type="text/javascript" src="javascript/jquery-1.10.2.min.js"></script>
	<script type="text/javascript" src="javascript/jqueryhotkeys.js"></script>
	<script type="text/javascript" src="javascript/key_status.js"></script>
	<script type="text/javascript" src="level1.js"></script>
	<script type="text/javascript" src="level2.js"></script>	
	<script type="text/javascript">
	
	//Load Game Assets

	var collision_image = new Image();
	collision_image.src = "assets/Noezark_testscene_collision.png";
	
	var background_image = new Image();
	background_image.src = "assets/Noezark_testscene1.png";
	
	var lyda_image = new Image();
	lyda_image.src = "assets/lyda.png";
	
	var lyda_image_left = new Image();
	lyda_image_left.src = "assets/lyda-left.png";
	
	var bobcat_image = new Image();
	bobcat_image.src = "assets/bobcat_walk1_1.png";
	
	var background_mall_ground_image = new Image();
	background_mall_ground_image = "assets/background_mall_ground_Collison.png";

	var background_mall_ground_image = new Image();
	background_mall_ground_image.src = "assets/background_mall_ground_Collison.png";
	
	var background_mall_grass_image = new Image();
	background_mall_grass_image.src = "assets/background_mall_Grass.png";
	
	var background_mall_collison_image = new Image();
	background_mall_collison_image.src = "assets/background_mall_ground_Collison.png";
	
	var background_mall_platforms = new Image();
	background_mall_platforms.src = "assets/background_mall_platforms_collision.png";

	var foreground_grass_image = new Image();
	foreground_grass_image.src = "assets/foreground-grass.png";

	/* Set Canvas contexts */
				
	var canvas = document.getElementById("main")		
	var cxt = canvas.getContext("2d");

	var canvas_width = canvas.width;
    var canvas_height = canvas.height;
	

	
	//Figure out order of object declaration
	
	var location0 = {
		//Begin information specific to the location if any
		
		//End location specific information
		//Begin information needed for all locations
		//List all elements, will be drawn in sequence
		background: new Array(
			background_mall_grass_image,
			background_mall_ground_image, 
			background_mall_collison_image
		),
		foreground: new Array(),
		//Walls and platforms
		collision_map: new Array(
			{x:0, y:418, width:800, height:30},
			{x:64, y:257, width:192, height:10},
			{x:64, y:337, width:81, height:10},		
			{x:176, y:337, width:176, height:10},
			{x:0, y:0, width:10, height:450},
			{x:590, y:0, width:10, height:450},
			{x:0, y:0, width:600, height:10}			
		),
		//Enemies and locations
		enemies: new Array(
			{type: "Bobcat", x:80, y:310, width:26, height:41}, 
			{type: "Bobcat", x:81, y:305, width:26, height:41},
			{type: "Bobcat", x:92, y:310, width:26, height:41}, 
			{type: "Bobcat", x:93, y:305, width:26, height:41},
			{type: "Bobcat", x:94, y:310, width:26, height:41}, 
			// {type: "Bobcat", x:300, y:305, width:26, height:41},
			// {type: "Bobcat", x:500, y:310, width:26, height:41}, 
			// {type: "Bobcat", x:550, y:305, width:26, height:41},
			// {type: "Bobcat", x:100, y:110, width:26, height:41}, 
			// {type: "Bobcat", x:99, y:205, width:26, height:41},
			// {type: "Bobcat", x:100, y:310, width:26, height:41}, 
			{type: "Bobcat", x:80, y:405, width:26, height:41}						
			
		),
		//Doors are entrance and exit points on map
		doors: new Array(
			{type:"normal", x:0, y:0, height:100, width:10, locked: true}, 
			{type:"normal", x:0, y:0, height:100, width:10, locked: true}
		),
		//Items
		item: new Array(
			{type:"Terrajump", x: 0, y:0}
		)
	}
	
	var location1 = {
		//Begin information specific to the location if any
		
		//End location specific information
		//Begin information needed for all locations
		//List all elements, will be drawn in sequence
		background: new Array(
			// background_mall_grass_image,
			background_mall_ground_image, 
			background_mall_collison_image
		),
		foreground: new Array(
			foreground_grass_image
		),
		//Walls and platforms
		collision_map: new Array(
			{x:0, y:418, width:800, height:30},
			{x:64, y:257, width:192, height:10},
			{x:64, y:337, width:81, height:10},		
			{x:176, y:337, width:176, height:10}
		),
		//Enemies and locations
		enemies: new Array(
			{type: "Bobcat", x:450, y:350, width:26, height:41}, 
			{type: "Bobcat", x:10, y:10, width:26, height:41}
		),
		//Doors are entrance and exit points on map
		doors: new Array(
			{type:"normal", x:0, y:0, height:100, width:10, locked: true}, 
			{type:"normal", x:0, y:0, height:100, width:10, locked: true}
		),
		//Items
		item: new Array(
			{type:"Terrajump", x: 0, y:0}
		)
	}
	
	//Main game data as well as viewport information, and general physics of the game
	//Maybe split this into separate objects
	var game_data = {
		screen_left: 0,
		screen_top: 0,
		x_velocity: 0,
		y_velocity: 0,
		x_max: 3,
		y_max: 6,
		x_acceleration: 1.2,
		y_acceleration: 1.2,
		friction: .8,
		location: location0
	};
	
	
	//Loops through all background images and draws them one on top of each other
	function background_draw(location) {
		var background_array = location.background.length;
		for (var i = 0; i < background_array; i++ ) {
			cxt.drawImage(location.background[i], game_data.screen_left, game_data.screen_top);
		}
	}
	
	function foreground_draw(location) {
		var foreground_array = location.foreground.length;
		for (var i = 0; i < foreground_array; i++ ) {
			cxt.drawImage(location.foreground[i], game_data.screen_left, game_data.screen_top);
		}
	}

	function collision_map_draw(location) {
		var collision_map_array = location.collision_map.length;
		for (var i = 0; i < collision_map_array; i++ ) {
			cxt.fillStyle="#FF0000";
			cxt.fillRect(location.collision_map[i].x, location.collision_map[i].y, location.collision_map[i].width, location.collision_map[i].height);
		}
	}
		
	//Returns the image data for the enemy type
	function enemy_image(type) {
		if (type == "Bobcat") {
			return bobcat_image;
		}
		else {
			console.log("No image for that enemy");
		}
	}
	
	//Loops through enemy array and draws all enemies
	//TODO add in functionality to change location of draw based on where the enemy should be
	function enemy_draw(location) {
		var enemies_array = location.enemies.length;
		for (var i = 0; i < enemies_array; i++ ) {
			cxt.drawImage(enemy_image(location.enemies[i].type), location.enemies[i].x, location.enemies[i].y);
		}
	}
	
	//Defines the collision_map, keeps it consistent to the map based on where the viewport is
	function collision_map_update(location) {
		var collision_map = location.collision_map.length;
		for (var i = 0; i < collision_map; i++ ) {
			location.collision_map[i].x = x + leftmost;
			location.collision_map[i].y = y + topmost;
		}
	}
		
	//Main character data and drawing
	//TODO move any character specific data from other objects into here
	//Add weapon data
	var lyda = {
		//Initial starting position will be determined by level and direction entered
		x: 100,
		y: 377,
		//Size of sprite
		width: 38,
		height: 41,
		//Animation keyframe
		keyframe: 0,
		//x can be left or right, y can be up, down, or forward
		facing_direction: {x: "left", y: "forward"},
		//Speed
		x_velocity: 0,
		y_velocity: 0,
		//Jump logic
		initial_jump: .5,
		grounded: true,
		jumping: false,
		jump_height:0,
		jump_max: 150,
		//Drawing functions
		//TODO keyframe animation based on facing_direction x and y
		draw: function() {
			if (this.facing_direction.x == "right") {
				var crop_left = this.keyframe * this.width;
				cxt.drawImage(lyda_image, crop_left, 0, this.width, this.height, this.x, this.y, this.width, this.height);
			}
			else if (this.facing_direction.x == "left") {
				var crop_left = this.keyframe * this.width;
				cxt.drawImage(lyda_image_left, crop_left, 0, this.width, this.height, this.x, this.y, this.width, this.height);
			}
		}
	}
	
	//Collision check code pulled from: http://www.somethinghitme.com/2013/04/16/creating-a-canvas-platformer-tutorial-part-tw/
	//TODO: Only check for collision between objects that are nearby each other
	function colCheck(shapeA, shapeB) {
		// get the vectors to check against
		var vX = (shapeA.x + (shapeA.width / 2)) - (shapeB.x + (shapeB.width / 2)),
		vY = (shapeA.y + (shapeA.height / 2)) - (shapeB.y + (shapeB.height / 2)),
		// add the half widths and half heights of the objects
		hWidths = (shapeA.width / 2) + (shapeB.width / 2),
		hHeights = (shapeA.height / 2) + (shapeB.height / 2),
		colDir = null;

		if (Math.abs(vX) < hWidths && Math.abs(vY) < hHeights) {
			var oX = hWidths - Math.abs(vX),
				oY = hHeights - Math.abs(vY);
			if (oX >= oY) {
			    if (vY > 0) {
			        colDir = "t";
			        shapeA.y += oY;
			    } 
				else {
			        colDir = "b";
			        shapeA.y -= oY;
			    }
			} 
			else {
				if (vX > 0) {
				    colDir = "l";
				    shapeA.x += oX;
				} else {
				    colDir = "r";
				    shapeA.x -= oX;
				}
			}
			// console.log(colDir);
			return colDir;
		}
	}
	
	function x_velocity_lyda(player) {
		if (player.x_velocity <= game_data.x_max && player.x_velocity > 0) {
			player.x_velocity = player.x_velocity * game_data.x_acceleration;		}
		else if (player.x_velocity >= game_data.x_max * -1 && player.x_velocity < 0) {
			player.x_velocity = player.x_velocity * game_data.x_acceleration;
		}
	}
	
	function y_velocity_lyda(player) {
		//Jumping up
		if (player.jumping == true && player.jump_height < player.jump_max) {
			player.y_velocity >= (-1 * game_data.y_max) ? player.y_velocity -= game_data.y_acceleration : player.y_velocity = (-1 *game_data.y_max);
			player.jump_height += (player.y_velocity * -1);
			console.log(player.jump_height);
		}
		
		if ((player.jumping == false && player.grounded == false) || (player.jump_height >= player.jump_max)) {
			player.y_velocity <= 0 ? player.y_velocity = 1 : player.y_velocity = player.y_velocity;
			player.y_velocity >= (game_data.y_max) ? player.y_velocity += game_data.y_acceleration : player.y_velocity = game_data.y_max;
			
		}
		
		//Reached max height of jump
		
		//Falling down logic
		
		//Nothing happening
	}
	
	
	//TODO Update should do a bunch of stuff based on key combinations, or lack thereof
	//Call functions to update object data, ie move objects, or destroy them
	//Additionally, check anything that should be checked each frame
	function update() {
		
		lyda.grounded = false;
		//Check for Lyda collision on level
		for (var i = 0; i < game_data.location.collision_map.length; i++) {
			var dir = colCheck(lyda, game_data.location.collision_map[i]);
			
			//If left or right, velocity = 0
			if (dir == "l" || dir == "r") {
				lyda.x_velocity = 0;
			}
			//If bottom then she is grounded and can jump again
			else if (dir == "b") {
				lyda.grounded = true;
				lyda.jumping = false;
				lyda.jump_height = 0;
			}
			//If top reverse velocity
			else if (dir == "t") {
				lyda.jump_height = lyda.jump_max;
			}
		}
		
		//Ground lyda
		if (lyda.grounded) {
			lyda.y_velocity = 0;
	    }
	
		//Check collision against any enemies
		for (var i = 0; i < game_data.location.enemies.length; i++) {
			var hit = colCheck(lyda, game_data.location.enemies[i]);
			if (hit != null) {
				//Do whatever we need to happen on hit here
			}
		}
		
		//Enemies 
		for (var i = 0; i < game_data.location.enemies.length; i++) {
			for (var p = 0; p < game_data.location.collision_map.length; p++) {
				colCheck(game_data.location.enemies[i], game_data.location.collision_map[p]);
			}
			if (game_data.location.enemies[i].x - lyda.x > 0 ) {
				game_data.location.enemies[i].x -= 2;
			}
			else {
				game_data.location.enemies[i].x += 2;
			}

			game_data.location.enemies[i].y += 1;
		}
		//Simple check to switch to a location and make sure everything is working
		if (keydown.b) {
			game_data.location = location1;
		}
		
		//Add enemies at random
		if (keydown.d) {
			game_data.location.enemies.push({type: "Bobcat", x:Math.floor(Math.random()*(200+1)), y:Math.floor(Math.random()*(300+1)), width:26, height:41});
		}
		
		//Left
		if (keydown.left) {
			lyda.x_velocity >= 0 ? lyda.x_velocity = -1 : lyda.x_velocity = lyda.x_velocity;
			lyda.facing_direction.x = "left"; 
		}
		//Right
		if (keydown.right) { 
			lyda.x_velocity <= 0 ? lyda.x_velocity = 1 : lyda.x_velocity = lyda.x_velocity;
			lyda.facing_direction.x = "right"; 
		}
		
		//Convience for flying around
		//TODO make these point her weapon arm up or down
		if (keydown.up) { lyda.y -= 5 }
		if (keydown.down) { lyda.y += 5 }

		//Jump
		if (keydown.a) {
			// up arrow or space
	        if (!lyda.jumping && lyda.grounded) {
	            lyda.jumping = true;
	            lyda.grounded = false;
	            lyda.y_velocity = -1;
	        }
		}
		
		if (!keydown.a) {
			lyda.jumping = false;
			lyda.y_velocity = 1;
		}
		
		//Not trying to move left or right
		if (!keydown.left && !keydown.right) {
			//Apply some friction for slowing down
			if (lyda.x_velocity != 0) {
				if (lyda.x_velocity > 0) {lyda.x_velocity = Math.floor(lyda.x_velocity * game_data.friction);}
				if (lyda.x_velocity < 0) {lyda.x_velocity = Math.ceil(lyda.x_velocity * game_data.friction);}
			}
		}
		
		
		//Calculate velocities
		x_velocity_lyda(lyda);
		y_velocity_lyda(lyda);	

		//Move Lyda based on velocities
		lyda.x += lyda.x_velocity;
		lyda.y += lyda.y_velocity;
	}

//Set frame rate
	var fps = 60;

//Main drawing function calls itself, runs update, and draws everything it should
	function draw() {
		setTimeout(function() {
			requestAnimationFrame(draw);
			//Run update loop
			update();

			//Clear the canvas completely
			cxt.clearRect(0, 0, canvas.width, canvas.height);
			//Draw the current location with its data
			background_draw(game_data.location);
			//Draw the current location's enemy data
			enemy_draw(game_data.location);
			//Draw the current location's item data
			
			//Draw black boxes for collision map
			collision_map_draw(game_data.location);
			//Draw Lyda along with her stat
			lyda.draw();
			//Draw foreground elements
			foreground_draw(game_data.location)
			//lyda.draw();

		}, 1000 / fps);
	}

	//Start it all off
	draw();
	</script>
</body>

</html>