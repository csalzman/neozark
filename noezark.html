<html>
<head>
	<style>
	</style>
</head>

<body>
	<div id="game">
		<canvas width="800" height="600" id="main"></canvas>
	</div>
	<script type="text/javascript" src="jquery-1.10.2.min.js"></script>
	<script type="text/javascript" src="jqueryhotkeys.js"></script>
	<script type="text/javascript" src="key_status.js"></script>
	
	<script type="text/javascript">

	var game_data = {
		current_time: new Date(),
		x_velocity: 0,
		y_velocity: 0,
		x_max: 5,
		y_max: 10,
		x_acceleration: 1,
		y_acceleration: 1.4
	};
	
	var boxes = new Array(
		{x:80, y:273, width:80, height:15},
		{x:208, y:207, width:194, height:18},
		{x:240, y:350, width:163, height:18},
		{x:80, y:432, width:113, height:18}	
	);
	
	function check_solid_ground() {
		for (var i = 0; i < boxes.length; i++) {
			//Check for bottom of lyda, top of box collision
			if ((lyda.x > boxes[i].x-lyda.width && (lyda.x) < (boxes[i].x + boxes[i].width))
				&& lyda.y <= boxes[i].y && (lyda.y + lyda.height) > (boxes[i].y)) {
				console.log('lyda-bottom');
				//Pin Lyda to the top of the platform
				lyda.y = boxes[i].y - lyda.height + 1;
				return lyda.platform = true;
			}
			//Check for top of lyda, bottom of box collision			
			else if ((lyda.x > boxes[i].x-lyda.width && (lyda.x) < (boxes[i].x + boxes[i].width))
				&& lyda.y <= (boxes[i].y + boxes[i].height) && (lyda.y + lyda.height) > (boxes[i].y + boxes[i].height)) {
				console.log('lyda-top');
				//Pin Lyda to the top of the platform
				lyda.y = boxes[i].y + lyda.height;
				// game_data.y_velocity = 10;
				return lyda.platform = true;
			}
			else {
				lyda.platform = false;
			}
		}
	}
	
	function x_velocity_check(direction) {
		switch(lyda.x_movement) {
		case "left":
			if (game_data.x_velocity > 0) { game_data.x_velocity = 0};
			game_data.x_velocity <= (game_data.x_max * -1) ? game_data.x_velocity = game_data.x_velocity : game_data.x_velocity -= game_data.x_acceleration;
		break;
		case "right":
			if (game_data.x_velocity < 0) { game_data.x_velocity = 0};
			game_data.x_velocity == game_data.x_max ? game_data.x_velocity = game_data.x_velocity : game_data.x_velocity += game_data.x_acceleration;			
		break;
		
		case "none":
			game_data.x_velocity = 0;
		break;	
		}
	}
	
	function y_velocity_check(direction) {
		switch(lyda.y_movement) {
		case "down":
			if (game_data.y_velocity <= 0) { game_data.y_velocity = 0.5};
			game_data.y_velocity >= game_data.y_max ? game_data.y_velocity = game_data.y_max : game_data.y_velocity = Math.ceil(game_data.y_velocity * game_data.y_acceleration);			
			console.log(game_data.y_velocity);
		break;
		case "up":
			lyda.y -= 1;
			if (game_data.y_velocity >= 0) { game_data.y_velocity = -0.5};
			game_data.y_velocity >= (game_data.y_max * -1) ? game_data.y_velocity = (game_data.y_max * -1) : game_data.y_velocity = (Math.ceil(game_data.y_velocity * game_data.y_acceleration)) * -1;			
			console.log(game_data.y_velocity);
		break;
		}
	}
	
	
	var collision_image = new Image();
	collision_image.src = "Noezark_testscene_collision.png";
	
	var background_image = new Image();
	background_image.src = "Noezark_testscene1.png";
	
	var background = {
		x:800,
		y:600,
		leftmost:0,
		topmost:0,
		draw: function() {
			//context.drawImage(img,sx,sy,swidth,sheight,x,y,width,height);
			cxt.drawImage(background_image, this.leftmost, this.topmost, this.x, this.y, 0, 0, this.x, this.y);
		}	
	};
	
	var collision = {
		x:800,
		y:600,
		leftmost:50,
		topmost:100,
		draw: function() {
			//context.drawImage(img,sx,sy,swidth,sheight,x,y,width,height);
			cxt.drawImage(collision_image, background.leftmost, background.topmost, background.x, background.y, 0, 0, background.x, background.y);
		}	
		
	}
	
	var lyda_image = new Image();
	lyda_image.src = "lyda.png";
	var lyda_image_left = new Image();
	lyda_image_left.src = "lyda-left.png";
	
	var lyda = {
		x:100,
		y:100,
		width:38,
		height:42,
		keyframe:0,
		x_direction: "left",
		y_direction: "none",
		x_movement: "none",
		platform: false,	
		jump: false,
		jump_time: undefined,
		draw: function() {
			if (this.x_direction == "right") {
				var crop_left = this.keyframe * this.width;
				cxt.drawImage(lyda_image, crop_left, 0, this.width, this.height, this.x, this.y, this.width, this.height);
			}
			else {
				var crop_left = this.keyframe * this.width;
				cxt.drawImage(lyda_image_left, crop_left, 0, this.width, this.height, this.x, this.y, this.width, this.height);
			}
		}
	}

	var level_size =  {
		height: background_image.height,
		width: background_image.width
	}
	
	/* Set Canvas contexts */
				
		var canvas = document.getElementById("main")		
		var cxt = canvas.getContext("2d");

		var canvas_width = canvas.width;
        var canvas_height = canvas.height;

		//Record keypresses and any other info that should be checked or updated every frame
		function update() {
			check_solid_ground();
			current_time = new Date();
			
			if (keydown.left) {
				//Point her in the right direction
				lyda.x_direction = "left";		
				//Set movement in right direction		
				lyda.x_movement = "left";
				//Continue velocity
				x_velocity_check(lyda.x_movement);
				//Advance animation frame
				lyda.keyframe == 9 ? lyda.keyframe = 0 : lyda.keyframe += 1;
			}
			
			if (keydown.right) {
				lyda.x_direction = "right";
				lyda.x_movement = "right";
				x_velocity_check(lyda.x_movement);
				lyda.keyframe == 9 ? lyda.keyframe = 0 : lyda.keyframe += 1;
			}
			
			//Not moving left or right
			if (!keydown.left && !keydown.right) {
				lyda.x_movement = "none";
				x_velocity_check(lyda.x_movement);
			}
			
			//Aim gun in appropriate direction
			if (keydown.down) {
				lyda.y_direction = "down";
				lyda.keyframe = 2;
			}
			if (keydown.up) {
				lyda.y_direction = "up";
				lyda.keyframe = 2;
			}

			//Jumping
			if (keydown.b) {
				lyda.jump = true;
				lyda.y_movement = "up";
				y_velocity_check(lyda.y_movement);

				// game_data.y_velocity -= 1;
			}
			else if (!keydown.b) {
				lyda.jump = false;
				// game_data.y_velocity += 1;
			}
			
			if (lyda.platform == false && lyda.jump == false) {
				lyda.y_movement = "down";
				y_velocity_check(lyda.y_movement);
			}
			else if (lyda.platform == true) {
				game_data.y_velocity = 0;
			}
				
			
			lyda.x += game_data.x_velocity;
			lyda.y += game_data.y_velocity;
			
		}

	//Set frame rate
		var fps = 30;

	//Main drawing function calls itself, runs update, and draws everything it should
		function draw() {
			setTimeout(function() {
				requestAnimationFrame(draw);
				update();
				
				background.draw();
				collision.draw();
				lyda.draw();
			}, 1000 / fps);
		}

	//Start it all off
		draw();
	</script>
</body>

</html>