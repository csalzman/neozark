<html>
<head>
	<style>
	body {
		background-color:gray;
	}
	#game {
		position: absolute;
		margin: auto;
		top: 0;
		right: 0;
		bottom: 0;
		left: 0;
		width:600px;
		height:450px;
		background-color:white;
	  }
	  .metrics_label {
		  font-weight:bold;
	  }
	</style>
</head>

<body>
	<div id="game">
		<canvas width="600" height="450" id="main" style="border:1px solid black"></canvas>
	</div>
	<div id="metrics">
		<p class="metrics_label">Current Frame<br/>
			<span id="current_frame"></span>
		</p>

		<p class="metrics_label">Lyda x Velocity<br/>
			<span id="lyda_x"></span>
		</p>
		
		<p class="metrics_label">Lyda y Velocity<br/>
			<span id="lyda_y"></span>
		</p>
		<p class="metrics_label">Location<br/>
			<span id="location"></span>
		</p>

	</div>
	<script type="text/javascript" src="javascript/jquery-1.10.2.min.js"></script>
	<script type="text/javascript" src="javascript/jqueryhotkeys.js"></script>
	<script type="text/javascript" src="javascript/key_status.js"></script>
	<script type="text/javascript" src="level1.js"></script>
	<script type="text/javascript" src="level2.js"></script>	
	<script type="text/javascript">
	
	//Load Game Assets

	var collision_image = new Image();
	collision_image.src = "assets/Noezark_testscene_collision.png";
	
	var background_image = new Image();
	background_image.src = "assets/Noezark_testscene1.png";
	
	var lyda_image = new Image();
	lyda_image.src = "assets/lyda.png";
	
	var lyda_image_left = new Image();
	lyda_image_left.src = "assets/lyda-left.png";
	
	var bobcat_image = new Image();
	bobcat_image.src = "assets/bobcat_walk1_1.png";
	
	var background_mall_ground_image = new Image();
	background_mall_ground_image = "assets/background_mall_ground_Collison.png";

	var background_mall_ground_image = new Image();
	background_mall_ground_image.src = "assets/background_mall_ground_Collison.png";
	
	var background_mall_grass_image = new Image();
	background_mall_grass_image.src = "assets/background_mall_Grass.png";
	
	var background_mall_collison_image = new Image();
	background_mall_collison_image.src = "assets/background_mall_ground_Collison.png";
	
	var background_mall_platforms = new Image();
	background_mall_platforms.src = "assets/background_mall_platforms_collision.png";

	var metro_background_image = new Image();
	metro_background_image.src = "assets/metro_background.png";

	var metro_collison_image = new Image();
	metro_collison_image.src = "assets/metro_Collison.png";

	var metro_foreground_image = new Image();
	metro_foreground_image.src = "assets/metro_foreground.png";


	var test_scene_background_image = new Image();
	test_scene_background_image.src = "assets/Noezark_testscene1.png";
	
	
	var test_scene_collison_image = new Image();
	test_scene_collison_image.src = "assets/Noezark_testscene_collision.png";

	/* Set Canvas contexts */
				
	var canvas = document.getElementById("main")		
	var cxt = canvas.getContext("2d");

	var canvas_width = canvas.width;
    var canvas_height = canvas.height;
	

	
	//Figure out order of object declaration
	
	var location0 = {
		//Begin information specific to the location if any
		
		//End location specific information
		//Begin information needed for all locations
		//List all elements, will be drawn in sequence
		name: "Grassy plain",
		background: new Array(
			background_mall_grass_image,
			background_mall_ground_image, 
			background_mall_collison_image
		),
		foreground: new Array(),
		//Walls and platforms
		collision_map: new Array(
			{x:0, y:418, width:800, height:30},
			{x:64, y:257, width:180, height:10},
			{x:64, y:337, width:60, height:10},		
			{x:176, y:337, width:176, height:10},
			{x:0, y:0, width:10, height:450},
			{x:590, y:0, width:10, height:450},
			{x:0, y:0, width:600, height:10}			
		),
		//Enemies and locations
		enemies: new Array(
			{type: "Bobcat", x:80, y:310, width:26, height:41, health: 10}, 
			{type: "Bobcat", x:80, y:405, width:26, height:41, health: 10}			
		),
		//Doors are entrance and exit points on map
		doors: new Array(
			{type:"normal", name: "east", x:580, y:320, height:100, width:10, locked: false, player_start: {x:540, y:320}, link: {location: "location1", door: "west"}}
		),
		//Items
		item: new Array(
			{type:"Terrajump", x: 0, y:0}
		)
	}
	
	var location1 = {
		//Begin information specific to the location if any
		
		//End location specific information
		//Begin information needed for all locations
		//List all elements, will be drawn in sequence
		name: "Subway",
		background: new Array(
			metro_background_image,
			metro_collison_image
		),
		foreground: new Array(
			metro_foreground_image
		),
		//Walls and platforms
		collision_map: new Array(
			{x:0, y:0, width:800, height:174},
			{x:0, y:420, width:800, height:174},
			{x:290, y:320, width:256, height:10},		
			{x:608, y:320, width:112, height:10}
		),
		//Enemies and locations
		enemies: new Array(
			{type: "Bobcat", x:450, y:350, width:26, height:41, health: 10}, 
			{type: "Bobcat", x:10, y:10, width:26, height:41, health: 10}
		),
		//Doors are entrance and exit points on map
		doors: new Array(
			{type:"normal", name: "west", x:0, y:320, height:100, width:10, locked: false, player_start: {x:20, y:320}, link: {location: "location0", door: "east"}},
			{type:"normal", name: "east", x:580, y:250, height:100, width:10, locked: false, player_start: {x:530, y:320}, link: {location: "location2", door: "west"}}			
		),
		//Items
		item: new Array(
			{type:"Terrajump", x: 0, y:0}
		)
	}
	
	var location2 = {
		//Begin information specific to the location if any
		
		//End location specific information
		//Begin information needed for all locations
		//List all elements, will be drawn in sequence
		name: "Test Area",
		background: new Array(
			test_scene_background_image,
			test_scene_collison_image
		),
		foreground: new Array(

		),
		//Walls and platforms
		collision_map: new Array(
			{x:0, y:0, width:800, height:10},
			{x:0, y:390, width:800, height:174},
			{x:20, y:260, width:64, height:14},		
			{x:182, y:328, width:80, height:14},
			{x:20, y:170, width:112, height:14}			
		),
		//Enemies and locations
		enemies: new Array(
		),
		//Doors are entrance and exit points on map
		doors: new Array(
			{type:"normal", name: "west", x:0, y:285, height:100, width:20, locked: false, player_start: {x:20, y:350}, link: {location: "location1", door: "east"}}
		),
		//Items
		item: new Array(
			{type:"Terrajump", x: 0, y:0}
		)
	}
	
	
	//Main game data as well as viewport information, and general physics of the game
	//Maybe split this into separate objects
	var game_data = {
		fps: 60,
		current_frame: 0,
		screen_left: 0,
		screen_top: 0,
		x_velocity: 0,
		y_velocity: 0,
		x_max: 5,
		y_max: 8,
		x_acceleration: 1.2,
		y_acceleration: 1.2,
		friction: .6,
		last_bullet: new Date(),
		location: location1
	};
	
	
	//Loops through all background images and draws them one on top of each other
	function background_draw(location) {
		var background_array = location.background.length;
		for (var i = 0; i < background_array; i++ ) {
			cxt.drawImage(location.background[i], game_data.screen_left, game_data.screen_top);
		}
	}
	
	function foreground_draw(location) {
		var foreground_array = location.foreground.length;
		for (var i = 0; i < foreground_array; i++ ) {
			cxt.drawImage(location.foreground[i], game_data.screen_left, game_data.screen_top);
		}
	}

	function collision_map_draw(location) {
		var collision_map_array = location.collision_map.length;
		for (var i = 0; i < collision_map_array; i++ ) {
			cxt.globalAlpha = 0.5;
			cxt.fillStyle="#FF0000";
			cxt.fillRect(location.collision_map[i].x, location.collision_map[i].y, location.collision_map[i].width, location.collision_map[i].height);
			cxt.globalAlpha = 1.0;
		}
	}
	
	function draw_doors(location) {
		var doors_array = location.doors.length;
		for (var i = 0; i < doors_array; i++ ) {
			location.doors[i].locked == true ? cxt.fillStyle="#838B8B" : cxt.fillStyle="#66CCCC";
			cxt.fillRect(location.doors[i].x, location.doors[i].y, location.doors[i].width, location.doors[i].height);
		}
		
	}
		
	//Returns the image data for the enemy type
	function enemy_image(type) {
		if (type == "Bobcat") {
			return bobcat_image;
		}
		else {
			console.log("No image for that enemy");
		}
	}
	
	//Loops through enemy array and draws all enemies
	//TODO add in functionality to change location of draw based on where the enemy should be
	function enemy_draw(location) {
		var enemies_array = location.enemies.length;
		for (var i = 0; i < enemies_array; i++ ) {
			cxt.drawImage(enemy_image(location.enemies[i].type), location.enemies[i].x, location.enemies[i].y);
		}
	}
	
	//Defines the collision_map, keeps it consistent to the map based on where the viewport is
	function collision_map_update(location) {
		var collision_map = location.collision_map.length;
		for (var i = 0; i < collision_map; i++ ) {
			location.collision_map[i].x = x + leftmost;
			location.collision_map[i].y = y + topmost;
		}
	}
		
	//Main character data and drawing
	//TODO move any character specific data from other objects into here
	//Add weapon data
	var lyda = {
		//Initial starting position will be determined by level and direction entered
		x: 400,
		y: 200,
		//Size of sprite
		width: 38,
		height: 41,
		//Animation keyframe
		keyframe: 0,
		animation_x_movement: 0,
		animation_frame_advance: 8,
		//x can be left or right, y can be up, down, or forward
		facing_direction: {x: "left", y: "up"},
		//Speed
		x_velocity: 0,
		y_velocity: 0,
		//Jump logic
		initial_jump: .5,
		grounded: true,
		jumping: false,
		jump_height:0,
		jump_max: 150,
		//Drawing functions
		//TODO keyframe animation based on facing_direction x and y
		draw: function() {
			if (this.facing_direction.x == "right") {
				var crop_left = this.keyframe * this.width;
				cxt.drawImage(lyda_image, crop_left, 0, this.width, this.height, this.x, this.y, this.width, this.height);
			}
			else if (this.facing_direction.x == "left") {
				var crop_left = this.keyframe * this.width;
				cxt.drawImage(lyda_image_left, crop_left, 0, this.width, this.height, this.x, this.y, this.width, this.height);
			}
		}
	}
	
	//Collision check code pulled from: http://www.somethinghitme.com/2013/04/16/creating-a-canvas-platformer-tutorial-part-tw/
	//TODO: Only check for collision between objects that are nearby each other
	function colCheck(shapeA, shapeB) {
		// get the vectors to check against
		var vX = (shapeA.x + (shapeA.width / 2)) - (shapeB.x + (shapeB.width / 2)),
		vY = (shapeA.y + (shapeA.height / 2)) - (shapeB.y + (shapeB.height / 2)),
		// add the half widths and half heights of the objects
		hWidths = (shapeA.width / 2) + (shapeB.width / 2),
		hHeights = (shapeA.height / 2) + (shapeB.height / 2),
		colDir = null;

		if (Math.abs(vX) < hWidths && Math.abs(vY) < hHeights) {
			var oX = hWidths - Math.abs(vX),
				oY = hHeights - Math.abs(vY);
			if (oX >= oY) {
			    if (vY > 0) {
			        colDir = "t";
			        shapeA.y += oY;
			    } 
				else {
			        colDir = "b";
			        shapeA.y -= oY;
			    }
			} 
			else {
				if (vX > 0) {
				    colDir = "l";
				    shapeA.x += oX;
				} else {
				    colDir = "r";
				    shapeA.x -= oX;
				}
			}
			// console.log(colDir);
			return colDir;
		}
	}
	
	function x_velocity_lyda(player) {
		if (player.x_velocity <= game_data.x_max && player.x_velocity > 0) {
			player.x_velocity = player.x_velocity * game_data.x_acceleration;		}
		else if (player.x_velocity >= game_data.x_max * -1 && player.x_velocity < 0) {
			player.x_velocity = player.x_velocity * game_data.x_acceleration;
		}
		
		if (player.x_velocity < (-1 * game_data.x_max)) {
			player.x_velocity = (-1 * game_data.x_max);
		}
		if (player.x_velocity > game_data.x_max) {
			player.x_velocity = game_data.x_max;
		}
		
	}
	
	function y_velocity_lyda(player) {
		//Jumping up
		if (player.jumping == true && player.jump_height <= player.jump_max) {
			player.y_velocity >= (-1 * game_data.y_max) ? player.y_velocity -= game_data.y_acceleration : player.y_velocity = (-1 * game_data.y_max);
			player.jump_height += (player.y_velocity * -1);
			// console.log(player.jump_height);
		}
		else if (player.jumping == true && player.jump_height >= player.jump_max) {
			player.y_velocity = 1;
		}
		
		if ((player.jumping == false && player.grounded == false) || (player.jump_height >= player.jump_max)) {
			// player.y_velocity <= 0 ? player.y_velocity = 1 : player.y_velocity = player.y_velocity;
			player.y_velocity >= (game_data.y_max) ? player.y_velocity += player.y_velocity * game_data.y_acceleration : player.y_velocity = game_data.y_max;
			
		}
		
		//Reached max height of jump
		
		//Falling down logic
		
		//Nothing happening
		
		//Even out velocity
		if (player.y_velocity < (-1 * game_data.y_max)) {
			player.y_velocity = (-1 * game_data.y_max);
		}
		if (player.y_velocity > game_data.y_max) {
			player.y_velocity = game_data.y_max;
		}
		
	}
	
	function animation_frame_lyda(player) {
		//Right or left
		// console.log(player.animation_x_movement);
		player.animation_x_movement += player.x_velocity;

		if (player.facing_direction.x == "right" && player.animation_x_movement >= player.animation_frame_advance && player.jumping != true) {
			player.keyframe <= 0 ? player.keyframe = 9 : player.keyframe -= 1;

			lyda.animation_x_movement = 0;
		}
		else if (player.facing_direction.x == "left" && player.animation_x_movement <= (-1 * player.animation_frame_advance) && player.jumping != true) {
			player.keyframe <= 0 ? player.keyframe = 9 : player.keyframe -= 1;
			lyda.animation_x_movement = 0;			
		}
		
		if (player.jumping == true) {
			player.keyframe = 0;
		}
		if (player.x_velocity == 0) {
			player.keyframe = 0;
		}
		
		//Up or Down
		if (player.facing_direction.y == "up") {
			
		}
		else if(player.facing_direction.y == "down") {
			
		}
	}
	
	function check_door(player) {
		for (var i = 0; i < game_data.location.doors.length; i++) {
			var hit = colCheck(player, game_data.location.doors[i]);
			if (hit != null && game_data.location.doors[i].locked == false) {
				//Grab name of the door you entered is linked to
				var linked_door = game_data.location.doors[i].link.door;
				
				//switch to new location
				game_data.location = eval(game_data.location.doors[i].link.location);
				console.log(game_data.location);
				//Find door in new location
				//Placeholder for the correct door in the array
				var correct_door = "";
				//Loop through new location looking for which door you're entering in
				for (var p = 0; p < game_data.location.doors.length; p++) {
					if (game_data.location.doors[p].name == linked_door) {
						correct_door = p;
					}
				}
				
				//Set player x and y to starting point for that door
				player.x = game_data.location.doors[correct_door].player_start.x;
				player.y = game_data.location.doors[correct_door].player_start.y;				
			}
		}
	}
	
	function viewport(location) {
		if (background.leftmostcanvas_width >= background.width && lyda.x_direction == "right") {
		     lyda.x < canvas.width - 50 ? lyda.x += game_data.x_velocity : lyda.x = lyda.x;
		        lyda.y += game_data.y_velocity;
		   }
		   //Viewport at left edge of level
		   else if (background.leftmost <= 1 && lyda.x_direction == "left") {
		     lyda.x > 1 ? lyda.x += game_data.x_velocity : lyda.x = lyda.x;
		     lyda.y += game_data.y_velocity;
		   }
		   //Viewport move left
		   else if (lyda.x < 250 && background.leftmost > 1 && lyda.x_direction == "left") {
		     background.leftmost += game_data.x_velocity;
		     lyda.y += game_data.y_velocity;      
        
		      }
		   //Viewport move right
		   else if (lyda.x > 350 && background.leftmostcanvas_width < background.width && lyda.x_direction == "right") {
		     background.leftmost += game_data.x_velocity;
		     lyda.y += game_data.y_velocity;
		   }    
   
		   //Viewport doesn't move, lyda does
		   else {
		     lyda.x += game_data.x_velocity;
		     lyda.y += game_data.y_velocity;      
		   }
	}
	
	var bullets = new Array;
	
	function draw_bullets(bullets) {
		for (var i = 0; i < bullets.length; i++) {
			cxt.fillStyle="#FF0000";

			if (bullets[i].direction == "right") {
				bullets[i].x += 10;				
			}
			else if (bullets[i].direction == "left") {
				bullets[i].x -=10;
			}
			cxt.fillRect(bullets[i].x, bullets[i].y, bullets[i].height, bullets[i].width);
		}
		
	}
	
	
	//TODO Update should do a bunch of stuff based on key combinations, or lack thereof
	//Call functions to update object data, ie move objects, or destroy them
	//Additionally, check anything that should be checked each frame
	function update() {
		
		var current_time = new Date();
		check_door(lyda);
		
		lyda.grounded = false;
		//Check for Lyda collision on level
		for (var i = 0; i < game_data.location.collision_map.length; i++) {
			var dir = colCheck(lyda, game_data.location.collision_map[i]);
			
			//If left or right, velocity = 0
			if (dir == "l" || dir == "r") {
				lyda.x_velocity = 0;
			}
			//If bottom then she is grounded and can jump again
			else if (dir == "b") {
				lyda.grounded = true;
				lyda.jumping = false;
				lyda.jump_height = 0;
			}
			//If top reverse velocity
			else if (dir == "t") {
				lyda.jump_height = lyda.jump_max;
			}
		}
		
		//Ground lyda
		if (lyda.grounded) {
			lyda.y_velocity = 0;
	    }
	
		//Check collision against any enemies
		for (var i = 0; i < game_data.location.enemies.length; i++) {
			var hit = colCheck(lyda, game_data.location.enemies[i]);
			if (hit != null) {
				//Do whatever we need to happen on hit here
			}
		}
		
		//Enemies 
		//Bullet Collide
		
		//Health check and remove dead ones
		for (var i = 0; i < game_data.location.enemies.length; i++) {
			if (game_data.location.enemies[i].health < 0) {
				game_data.location.enemies.splice(i, 1);
			}
		}
		
		//Collision and movement
		for (var i = 0; i < game_data.location.enemies.length; i++) {
			for (var b = 0; b < bullets.length; b++) {
				var hit = colCheck(game_data.location.enemies[i], bullets[b]);
				if (hit != null) {
					console.log("hit");
					game_data.location.enemies[i].health -= 5;
				}
			}
			
			for (var p = 0; p < game_data.location.collision_map.length; p++) {
				colCheck(game_data.location.enemies[i], game_data.location.collision_map[p]);
			}
			
			if (game_data.location.enemies[i].x - lyda.x > 0 ) {
				game_data.location.enemies[i].x -= 2;
			}
			else {
				game_data.location.enemies[i].x += 2;
			}

			game_data.location.enemies[i].y += 1;
		}
		//Simple check to switch to a location and make sure everything is working
		if (keydown.b) {
			game_data.location = location1;
		}
		
		//Add enemies at random
		if (keydown.d) {
			game_data.location.enemies.push({type: "Bobcat", x:Math.floor(Math.random()*(200+1)), y:Math.floor(Math.random()*(300+1)), width:26, height:41, health:10});
		}
		
		//TODO Pull out bullet logic and assign it to weapons
		if (keydown.s) {
			if (Math.abs(game_data.last_bullet - current_time) > 300) {
				game_data.last_bullet = new Date();			
				if (lyda.facing_direction.x == "right") {
					bullets.push({x:(lyda.x + lyda.width + lyda.x_velocity), y:(lyda.y + 6), height: 10, width: 10, direction: lyda.facing_direction.x}); 
				}
				else if (lyda.facing_direction.x == "left") {
					bullets.push({x:(lyda.x - lyda.x_velocity), y:(lyda.y + 6), height: 10, width: 10, direction: lyda.facing_direction.x});
				}
			}
			if (bullets.length > 5) {
				bullets.shift();
			}
		}
		
		//Left
		if (keydown.left) {
			lyda.x_velocity >= 0 ? lyda.x_velocity = -1 : lyda.x_velocity = lyda.x_velocity;
			lyda.facing_direction.x = "left"; 
		}
		//Right
		if (keydown.right) { 
			lyda.x_velocity <= 0 ? lyda.x_velocity = 1 : lyda.x_velocity = lyda.x_velocity;
			lyda.facing_direction.x = "right"; 
		}
		
		//Jump
		if (keydown.a) {
			// up arrow or space
	        if (!lyda.jumping && lyda.grounded) {
	            lyda.jumping = true;
	            lyda.grounded = false;
	            lyda.y_velocity = -1;
	        }
			else {
				lyda.y_velocity = lyda.y_velocity;
			}
		}
		
		//Not jumping
		if (!keydown.a) {
			lyda.jumping = false;
			lyda.y_velocity = 1;
		}
		
		//Not trying to move left or right
		if (!keydown.left && !keydown.right) {
			//Apply some friction for slowing down
			if (lyda.x_velocity != 0) {
				if (lyda.x_velocity > 0) {lyda.x_velocity = Math.floor(lyda.x_velocity * game_data.friction);}
				if (lyda.x_velocity < 0) {lyda.x_velocity = Math.ceil(lyda.x_velocity * game_data.friction);}
			}
		}
		
		//Calculate velocities
		x_velocity_lyda(lyda);
		y_velocity_lyda(lyda);	

		//Advance animations
		animation_frame_lyda(lyda);
		
		//Move Lyda based on velocities
		lyda.x += lyda.x_velocity;
		lyda.y += lyda.y_velocity;
	}


//Set frame rate
	var fps = game_data.fps;

//Main drawing function calls itself, runs update, and draws everything it should
	function draw() {
		setTimeout(function() {
			game_data.current_frame == game_data.fps ? game_data.current_frame = 0 : game_data.current_frame += 1;
			requestAnimationFrame(draw);
			//Run update loop
			update();

			//Clear the canvas completely
			cxt.clearRect(0, 0, canvas.width, canvas.height);
			//Draw the current location with its data
			background_draw(game_data.location);
			//Draw the current location's enemy data
			enemy_draw(game_data.location);
			//Draw the current location's item data
			
			//Draw black boxes for collision map
			collision_map_draw(game_data.location);
			//Draw Lyda along with her stat
			lyda.draw();
			//Bullets
			draw_bullets(bullets);
			//Draw Doors
			draw_doors(game_data.location);
			//Draw foreground elements
			foreground_draw(game_data.location);
			useful_metrics();

		}, 1000 / fps);
	}

	//Start it all off
	draw();	
	


	function useful_metrics() {
		$("#current_frame")[0].innerHTML = game_data.current_frame;
		$("#lyda_x")[0].innerHTML = lyda.x_velocity;
		$("#lyda_y")[0].innerHTML = lyda.y_velocity;
		$("#location")[0].innerHTML = game_data.location.name;
	}
	</script>
</body>

</html>